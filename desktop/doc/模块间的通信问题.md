# NMM 同 NMM 建立 ReadableStreamIpc 的方法


## 文件目录
- test.form.nmm.cts
- test.to.nmm.cts


## 代码实现

- test.from.nmm.cts
```ts

import type { $BootstrapContext } from "../core/bootstrapContext.cjs";
import { ReadableStreamIpc } from "../core/ipc-web/ReadableStreamIpc.cjs";
import { IpcEvent, IpcStreamData, IPC_ROLE } from "../core/ipc/index.cjs";
import { NativeMicroModule } from "../core/micro-module.native.cjs"


export class TestFromNMM extends NativeMicroModule{
  mmid = "test-from.sys.dweb" as const;


  async _bootstrap(context: $BootstrapContext){
    console.log(`${this.mmid} _bootstrap`)
      //创建 nativeIpc 连接 到 toNMM
      console.log("开始发起连接")
      // 一般而言不直接调用这个实现连接
      // 这个连接的方法用来实现可以通过直接发起请求的操作 fiel://test-to.sys.dweb/path 这样的操作
      // 返回一个 steam 就可以了
      const readableStreamIpcToTestToSysDweb = new ReadableStreamIpc(this, IPC_ROLE.SERVER);
      readableStreamIpcToTestToSysDweb.onMessage(message => {
        console.log(this.mmid, "readableStreamIpcToTestToSysDweb 接受到了message", message);
        // 测试关闭
        // 关闭之后 对方无法再接受到消息
        // 关闭之后会触发调用 close() 方法的 ReadableStream.onClose(callback)注册 的 callback 方法ß
        readableStreamIpcToTestToSysDweb.close()
      })

      readableStreamIpcToTestToSysDweb.onClose(() => {
        console.log(`${this.mmid} readableStreamIpcToTestToSysDweb 关闭了`)
      })

      // 发起请求
      // readableStream bind 返回的 stream 为请求的返回的对象
      const result = this.nativeFetch(
        `file://test-to.sys.dweb/connect/readable_stream`,
        {
          method: "POST",
          body: readableStreamIpcToTestToSysDweb.stream
        }  
      )
      readableStreamIpcToTestToSysDweb.bindIncomeStream(result.stream())

      // 可以发送 IpcEvent 消息了
      // readableStreamIpcToTestToSysDweb.postMessage(
      //   IpcEvent.fromText('testmessage', "test-message-content")
      // )

      // 如何发送stream消息了？？
      // 可以通过下面的方法发送 strteam 消息
      // $IpcStreamMessage =
      // 创建一个stream
      const streamid = "1"
      const uit8 = new TextEncoder().encode('name-stream')
      readableStreamIpcToTestToSysDweb.postMessage(
        IpcStreamData.fromUtf8(streamid, uit8)
      )
  }

  protected _shutdown() {
    
  }
}


```


-test.to.nmm.cts
```ts


import type { $BootstrapContext } from "../core/bootstrapContext.cjs";
import { ReadableStreamIpc } from "../core/ipc-web/ReadableStreamIpc.cjs";
import { IPC_ROLE } from "../core/ipc/const.cjs";
import { IpcEvent } from "../core/ipc/index.cjs";
import type { Ipc } from "../core/ipc/index.cjs";
import { NativeMicroModule } from "../core/micro-module.native.cjs"


export class TestToNMM extends NativeMicroModule{
  mmid = "test-to.sys.dweb" as const;

  
  readableStreamIpcToTestFromSysDweb = new ReadableStreamIpc(this, IPC_ROLE.CLIENT);

  _bootstrap(context: $BootstrapContext){
    console.log(`${this.mmid} _bootstrap`)

    // 创建 ReadableStreamIpc 通道
    this.registerCommonIpcOnMessageHandler({
      method: "POST",
      pathname: "/connect/readable_stream",
      matchMode: "full",
      input: {},
      output: "object",
      handler: async (args, ipc, request) => {
        // NMM 发起的连接 remote.mmid === 发起方的 mmid 没有中间代理
        console.log(ipc.remote.mmid)
        this.readableStreamIpcToTestFromSysDweb.bindIncomeStream(request.body.stream());
        // 必须要返回一个 stream
        return this.readableStreamIpcToTestFromSysDweb.stream;
      }
    })

    // onMesasge 能够接收到全部的发送过来的消息
    // this.readableStreamIpcToTestFromSysDweb.onMessage(message => {
    //   console.log(`${this.mmid} readableStreamIpcToTestFromSysDweb 接受到了消息`, message)
    //   this.readableStreamIpcToTestFromSysDweb.postMessage(
    //     IpcEvent.fromText('test-message', "test-message-from-to-nmm")
    //   )
    // })

    this.readableStreamIpcToTestFromSysDweb.onClose(() => {
      console.log(`${this.mmid} readableStreamIpcToTestFromSysDweb 接受到了关闭的信号`)
    })

    this.readableStreamIpcToTestFromSysDweb.onStream(stream => {
      console.log(`${this.mmid} readableStreamIpcToTestFromSysDweb 接受到了 stream`, stream.type)
    })

  }

  protected _shutdown() {
    
  }
}

```

