<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>navgation-bar</title>
    <style type="text/css">
        body{
            position: relative;
            box-sizing: border-box;
            margin: 0px;
            width: 100%;
            height: 70px;
        }
    </style>
</head>
<body>
    <template id="template">
        <div class="item-container">
            <div class="icon-container"></div>
            <div class="label-container"></div>
        </div>
    </template>
    <navgation-bar></navgation-bar>
    
    <!-- 创建一个WebComponent -->
    <script type="text/javascript">

        let state = {
            color: "#FFFFFFFF",
            style: "DEFAULT",
            overlay: false,
            visible: true,
            insets: {
                top: 70,
                right: 0,
                bottom: 0,
                left: 0
            }
        }

        log = (...args) => {
                console.log(`navigation-bar.html`, ...args)
        }

        class NavigationBar extends HTMLElement{
            _root
            _fragement = document.createDocumentFragment()
            _elStyle = document.createElement('style')
            _appUrl = "" // 发起请求的plugins 所在的 origin
            _template;
            _iframe
            _iframeHeightShow = "70px";
            _iframeHeightHide = "0px"
            _listenerClickId = null // plugins 发起监听点击事件请求的 id

            constructor(){
                super()
                this._root = this.attachShadow({mode: "open"})
                this._init()
            }

            connectedCallback(){
                this._iframe = window.top.document.querySelector("view-tree").shadowRoot.querySelector("multi-webview-content").shadowRoot.querySelector('#navgation-bar');
                this._appUrl = this._iframe.dataset.appUrl
                this._awaitOperation()
            }

            _init(){
                this
                ._initStyle()
                ._initTemplate()
            }

            _initStyle = () => {
                this._elStyle.setAttribute('type', "text/css")
                this._elStyle.innerText = createStyle()
                this._root.append(this._elStyle);
                return this;
            }

            _initTemplate = () => {
                this._template = document.querySelector('#template');
                return this;
            }

            _initState = () => {
                this._iframe.style.height = `${state.top}px`;
                document.documentElement.style.setProperty('--background-color', state.color);
            }

            getState = () => {
                return JSON.stringify({
                    ...state,
                    color: this.hexaToRGBA(state.color)
                });
            }
            
            hexaToRGBA(str){
                return{
                    red: parseInt(str.slice(1,3), 16),
                    green: parseInt(str.slice(3,5), 16),
                    blue: parseInt(str.slice(5,7), 16),
                    alpha: parseInt(str.slice(7), 16)
                }
            }

            /**
             * 设置 内容
            */
            setNavigatorbarContent = (arr) => {
                this._fragement
                const host = new URL(this._appUrl).host
                arr.forEach(item => {
                    const el = this._template.content.firstElementChild.cloneNode(true)
                    el.addEventListener('click', () => this._clickItem(item))
                    el.firstElementChild.style.backgroundImage=`url('http://${host}${item.icon}')`
                    el.lastElementChild.innerText = item.label;
                    this._fragement.append(el)
                })
                this._fragement.append(this._elStyle);
                this._root.append(this._fragement);
                this._show()
            }
 

            // 点击事件的触发
            _clickItem = (item) => {
                if(this._listenerClickId === null) console.error('NavigationBar 点击事件还没有监听')
                this._fetchReturn(item.id, this. _listenerClickId)
                this._listenerClickId = null;
            }
            
            /**
             * req_id 
             */ 
            _listenerClick = async (req_id/*plugins 发起请求的标识符*/) => {
                this._listenerClickId = req_id
            }

            /*
            监听操作的方法
            */
            _awaitOperation = async () =>{
                fetch("http://navigation-bar.nativeui.sys.dweb-80.localhost:22605/navigation-bar-ui/wait_for_operation?app_url="+this._appUrl)
                .then(async (res) => {
                    console.log('----navigation-bar.html 接受到了操作请求')
                    const reader = res.body.getReader();
                    let loop = true;
                    do{
                        const {value, done} = await reader.read()
                        loop = !done;
                        if(!value) continue;
                        const data = JSON.parse(new TextDecoder().decode(value))
                        if(!this._appUrl.startsWith(data.from)) continue;
                        log("等待操作的请求： ", data)
                         
                        switch(data.operationName){
                            case "get_state":
                                this._fetchReturn(this.getState(), data.id, data.from);
                                break;
                            case "set_background_color":   
                                this._setBackgroundColor(data.value); 
                                this._fetchReturn(this.getState(), data.id, data.from); 
                                break;
                            case "set_style":
                                this._setStyle(data.value); 
                                this._fetchReturn(this.getState(), data.id, data.from);
                                break;
                            case "set_overlay":
                                this._setOverlay(data.value); 
                                this._fetchReturn(this.getState(), data.id, data.from);
                                break;
                            case "set_visible":
                                this._setVisible(data.value); 
                                this._fetchReturn(this.getState(), data.id, data.form);
                                break;
                            default: throw new Error(`navigation-bar.html 操作没有匹配的处理器 ${data.operationName}`);
                    }
                    }while(loop)
                })
                .catch(err => {
                    console.error('statusbar err： ', err)
                })
            }

            // 用来发送返回的数据
            _fetchReturn = (data,id, from) => {
                fetch(
                    "http://navigation-bar.nativeui.sys.dweb-80.localhost:22605/navigation-bar-ui/operation_return?app_url="+this._appUrl,
                    {
                        method: 'POST',
                        body: data,
                        headers: {
                            "Content-Type": "application/json; charset=UTF-8",
                            "id": id
                        }
                        
                    }
                )
                .catch(err => console.error("fetchReturn 出错", err))
            }

            _setBackgroundColor = (color) => {
                state.color = color;
                document.querySelector("navgation-bar").style.background = state.color
                return this;
            }

            _setStyle = (style) => {
                state.style = style;
                console.warn(`navigation-bar.html 设置了 style 但是还不知道处理如何的效果`)
            }

            _setOverlay = (overlay) => {
                state.overlay = overlay;
                this._iframe.style.position = overlay ? "absolute" : "relative";
                console.log("overlay ", overlay)
            }

            _setVisible = (visible) => {
                state.visible = visible;
                this._iframe.style.display = visible ? "block" : "none";
            }
        }

        customElements.define('navgation-bar', NavigationBar)

        function createStyle(){
            return `
                :host{
                    display: flex;
                    justify-content: space-around;
                    align-items: center;
                    width: 100%;
                    height: 100%;
                    background: #FFFFFFFF;
                    
                }
                .item-container{
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-start;
                    align-items: center;
                    width: 50px;
                    height: 60px;
                    // background: #0002;
                }

                .icon-container{
                    width: 30px;
                    height: 30px;
                    background-size: contain;
                    background-position: center;
                }

                .label-container{
                    width: 100%;
                    height:20px;
                    line-height: 20px;
                    font-size: 10px;
                    font-weight: 100;
                    text-align: center;
                }
            `
        }

    </script>
</body>
</html>