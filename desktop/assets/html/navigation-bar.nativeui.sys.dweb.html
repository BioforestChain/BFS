<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>navgation-bar</title>
  <!-- 向全局对象添加 appUrl 属性 appUrl 指向的是 当前插件匹配的 webview.src -->
  <script type="text/javascript" src="../scripts/defined_app_url.js"></script>
  <script type="text/javascript" src="../scripts/defined_plugins.js"></script>
  <style type="text/css">
    body{
      position: relative;
      box-sizing: border-box;
      margin: 0px;
      width: 100%;
      height: 20px;
    }

    .container{
      position: relative;
      box-sizing: border-box;
      width: 100%;
      height: 20px;
    }
    .background{
      position: absolute;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
      background: #FFFFFF00;
    }

    .line-container{
      position: absolute;
      top: 0px;
      left: 0px;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .line{
      width: 50%;
      height:4px;
      border-radius:4px;
    }

    .line-default{
      background: #FFFFFFFF;
    }

    .line-dark{
      background: #000000FF;
    }

    .line-light{
      background: #FFFFFFFF;
    }

    .navigation_bar_container{
      position: absolute;
      top: 0px;
      left: 0px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .navigation_bar_container_defualt{
      color: #FFFFFFFF;
    }

    .navigation_bar_container_dark{
      color: #000000FF;
    }

    .navigation_bar_container_light{
      color: #FFFFFF;
    }

    .icon_svg{
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="background"></div>
    <!-- ios 下划线 -->
    <div class="line-container">
      <div class="line line-dark"></div>
    </div>
    <!-- android 导航栏 -->
    <div class="navigation_bar_container navigation_bar_container_dark">
      <div class="menu" onclick="menu()">
        <svg 
          class="icon_svg menu_svg"
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 448 512"
        >
          <path 
            fill="currentColor"
            d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"
          />
        </svg>
      </div>
      <div class="home" onclick="home()">
        <svg
          class="icon_svg" 
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 512 512"
        >
          <path 
            fill="currentColor"
            d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256z"
          />
        </svg>
      </div>
      <div class="back" onclick="back()">
        <svg 
          class="icon_svg" 
          viewBox="0 0 1024 1024" 
          version="1.1" 
          xmlns="http://www.w3.org/2000/svg" 
        >
          <path 
            fill="currentColor"
            d="M814.40768 119.93088a46.08 46.08 0 0 0-45.13792 2.58048l-568.07424 368.64a40.42752 40.42752 0 0 0-18.75968 33.71008c0 13.39392 7.00416 25.96864 18.75968 33.66912l568.07424 368.64c13.35296 8.68352 30.72 9.66656 45.13792 2.58048a40.67328 40.67328 0 0 0 23.38816-36.2496v-737.28a40.71424 40.71424 0 0 0-23.38816-36.29056zM750.3872 815.3088L302.81728 524.86144l447.61088-290.44736v580.89472z" 
          >
          </path>
        </svg>
      </div>
    </div>
  </div>   
</body>
<script type="text/javascript">
  const mmid = `navigation-bar.nativeui.sys.dweb`
  // 是否模拟的是 android 手机的状态
  let isAndroid = true;
  var state = {
      color: "#FFFFFFFF",
      style: "DARK",
      overlay: false,
      visible: true,
      insets: {
          top: 0,
          right: 0,
          bottom: 20,
          left: 0
      }
  }
  const elBackground = document.querySelector('.background');
  const elLine = document.querySelector('.line');
        elLine.remove();
  const elAndroid = document.querySelector('.navigation_bar_container');

  function log(...args){
    console.log(`${mmid}`, ...args)
  }

  function err(...args){
    console.error(`${mmid}`, ...args)
  }

  function windowOnMessage (){
    awaitOperation()
    window.removeEventListener('message', windowOnMessage)
  }
  
  async function awaitOperation(){
    const baseUrl = "http://navigation-bar.nativeui.sys.dweb-80.localhost:22605/navigation-bar-ui/wait_for_operation"
    // window.appUrl 是通过 mwebview.sys.dweb 注入进来的
    // appUrl 指向 mwebview 标签的 src;
    const searchStr = `?app_url=${window.appUrl}`
    fetch(`${baseUrl}${searchStr}`)
    .then(async (res) => {
      const reader = res.body.getReader();
      let loop = true;
      do{
        const {value, done} = await reader.read()
        loop = !done;
        if(!value) continue;
        const data = JSON.parse(new TextDecoder().decode(value))
        if(!window.appUrl.startsWith(data.from)) continue;
        log("等待操作的请求： ", data)
        switch(data.operationName){
          case "get_state":
            fetchReturn(getState(), data.id, data.from);
            break;
          case "set_background_color":   
            setBackgroundColor(data.value); 
            fetchReturn(getState(), data.id, data.from); 
            break;
          case "set_style":
            setStyle(data.value); 
            fetchReturn(getState(), data.id, data.from);
            break;
          case "set_overlay":
            setOverlay(data.value); 
            fetchReturn(getState(), data.id, data.from);
            break;
          case "set_visible":
            setVisible(data.value); 
            fetchReturn(getState(), data.id, data.from);
            break;
          default: throw new Error(`navigation-bar.html 操作没有匹配的处理器 ${data.operationName}`);
        }
      }while(loop)
    })
    .catch(err => {
      console.error('statusbar err： ', err)
    })
  }

  function fetchReturn(data,id, from){
    fetch(
      "http://navigation-bar.nativeui.sys.dweb-80.localhost:22605/navigation-bar-ui/operation_return?app_url="+window.appUrl,
      {
        method: 'POST',
        body: data,
        headers: {
          "Content-Type": "application/json; charset=UTF-8",
          "id": id,
          "from": from
        }
      }
    )
    .catch(err => console.error("fetchReturn 出错", err))
  }

  function setBackgroundColor(color){
    state.color = color;
    elBackground.style.background = state.color;
  }

  function setStyle(style){
    state.style = style;
    switch(style){
      case "DEFAULT":
        isAndroid 
        ? elAndroid.setAttribute('class', `navigation_bar_container navigation_bar_container_default`)
        : elLine.setAttribute('class', `line line-default`);
        break;
      case "DARK":
        isAndroid
        ? elAndroid.setAttribute('class', `navigation_bar_container navigation_bar_container_dark`)
        : elLine.setAttribute('class', `line line-dark`);
        break;
      case "LIGHT":
        isAndroid
        ? elAndroid.setAttribute('class', `navigation_bar_container navigation_bar_container_light`)
        : elLine.setAttribute('class', `line line-light`)
        break;
      default: throw new Error(`navigation-bar setStyle 非法的style ${style}`)
    }
  }

  /**
   * 需要同 status-bar | virtual-keyboard | safe-area 关联起来
   */
  function setOverlay(overlay){
    const isSame = state.overlay === overlay;
    state.overlay = overlay;
    window.navigationBar.style.position = state.overlay ? "absolute" : "relative";
    elBackground.style.display = state.overlay ? "none" : "block";
    
    if(isSame) return; // 相同不需要联动 safe-area
    // 不相同需要联动 safe-area;
    window.safeArea.contentWindow.overlayChange({type: 'navigation-bar', value: state.overlay})
  }

  function setOverlayBySysModule(overlay){
    if(state.overlay === overlay) return;
    state.overlay = overlay
    window.navigationBar.style.position = state.overlay ? "absolute" : "relative";
    elBackground.style.display = state.overlay ? "none" : "block";
    fetchReturn(getState(), "observe", window.appUrl)
  }

  function setVisible(visible){
    state.visible = visible;
    state.insets.bottom = visible ? 20 : 0;
    window.navigationBar.style.display = visible ? "block" : "none";
  }

  function getState(){
    const o = {
        ...state,
        color: hexaToRGBA(state.color)
    }
    return  JSON.stringify(o);
  }

  function hexaToRGBA(str){
    return{
      red: parseInt(str.slice(1,3), 16),
      green: parseInt(str.slice(3,5), 16),
      blue: parseInt(str.slice(5,7), 16),
      alpha: parseInt(str.slice(7), 16)
    }
  }

  function getStateObject(){
    return state
  }

  function menu(){
    err(`点击了menu但是还没有处理`)
  }

  function home(){
    err(`点击了 home 但是还没有处理`);
  }

  function back(){
    const elWebview = window.parentElement.querySelector('webview')
    elWebview.executeJavaScript(`
      (() => {
        const watchers = Array.from(globalThis.__native_close_watcher_kit__._watchers.values())
        if(watchers.length === 0){
          window.history.back();
        }else{
          watchers[watchers.length - 1].close()
        }
      })()
    `)
  }
</script>
<script type="text/javascript">
  window.addEventListener('message', windowOnMessage)
</script>
</html>