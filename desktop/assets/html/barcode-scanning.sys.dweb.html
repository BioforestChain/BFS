<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>barcode-scanning</title>
    <script type="text/javascript" src="../scripts/defined_app_url.js"></script>
    <script type="text/javascript" src="../scripts/defined_plugins.js"></script>
    <style type="text/css">
        .input{
            width: 100px;
            height: 30px;
            border: 1px solid red;
            /* visibility: hidden; */
        }
    </style>
</head>
<body>
    <input type="file" class="input"/>
    <script type="text/javascript">
        console.log('barcode-scanning ui 载入完成')
        window.addEventListener('message', windowOnMessage)
        function windowOnMessage (){
            awaitOperation()
            window.removeEventListener('message', windowOnMessage)
        }
        
        /*
            监听操作的方法
        */
        async function awaitOperation(){
            fetch("http://barcode-scanning.sys.dweb-80.localhost:22605/barcode-scanning-ui/wait_for_operation?app_url="+window.appUrl)
            .then(async (res) => {
                const reader = res.body.getReader()
                let loop = true;
                do{
                    const {value, done} = await reader.read()
                    loop = !done
                    if(!value) continue;
                    const o = JSON.parse(new TextDecoder().decode(value))
                    console.log('请求的结果： ', o)
                    if(!appUrl.startsWith(o.from)) continue;
                    switch(o.operationName){
                        case "getPhoto":
                            getPhoto(o);
                            break;
                        default: console.error('statusbar 没有匹配的功能 o.operationName === ', o.operationName)
                    }
                }while(loop)
            })
            .catch(err => {
                console.error('statusbar err： ', err)
            })
        };

        // 通过发送请求把数据传送回去
        function fetchReturn(value,id, from, contentType){
            console.log('value: ', value)
            fetch(
                "http://barcode-scanning.sys.dweb-80.localhost:22605/barcode-scanning-ui/operation_return?app_url="+from,
                {
                    method: 'POST',
                    body: value,
                    headers: {
                        // "Content-Type": "application/json; charset=UTF-8",
                        "Content-Type": contentType,
                        "id": id,
                    }
                }
            )
            .catch(err => console.error("fetchReturn 出错", err))
        }
        
    </script>
    <script type="text/javascript">

        function getPhoto(o){
            const elInput = document.createElement('input')
            elInput.setAttribute('type', "file");
            elInput.addEventListener('change', change)
            function change(){
                console.log('file: ', elInput.files[0]);

                elInput.remove();
                fetchReturn(elInput.files[0], o.id, o.from, elInput.files[0].type)
                elInput.removeEventListener('change', change)
            }

            // o.id, o.from
            console.log(o)
            const parentElement = window.parentElement;
            parentElement.appendChild(elInput);
            elInput.click()
        }

    </script>
</body>
</html>