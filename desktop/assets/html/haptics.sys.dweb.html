<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>haptics.sys.dweb</title>
  <script type="text/javascript" src="../scripts/defined_app_url.js"></script>
</head>
<body>
  <script type="text/javascript">
    window.addEventListener('message', windowOnMessage)
    function windowOnMessage (){
      awaitOperation()
      window.removeEventListener('message', windowOnMessage)
    }
    
    /*
        监听操作的方法
    */
    async function awaitOperation(){
      fetch("http://haptics.sys.dweb-80.localhost:22605/haptics_sys_dweb_ui/wait_for_operation?app_url="+window.appUrl)
      .then(async (res) => {
        console.log('res: ', res)
          const reader = res.body.getReader()
          let loop = true;
          do{
              const {value, done} = await reader.read()
              loop = !done
              if(!value) continue;
              const o = JSON.parse(new TextDecoder().decode(value))
              console.log('haptics.sys.dweb.html 请求的结果： ', o)
              
              if(!appUrl.startsWith(o.from)) continue;
              switch(o.operationName){
                case "impactLight":
                  showMessage(`impactLight === ${o.value}`)
                  break;
                case "notification":
                  showMessage(`notification === ${o.value}`)
                  break;
                case "vibrateClick":
                  showMessage(`vibrateClick === ${o.value}`)
                  break;
                case "vibrateDisabled":
                  showMessage(`vibrateDisabled === ${o.value}`)
                  break;
                case "vibrateDoubleClick":
                  showMessage(`vibrateDoubleClick === ${o.value}`)
                  break;
                case "vibrateHeavyClick":
                  showMessage(`vibrateHeavyClick === ${o.value}`)
                  break;
                case "vibrateTick":
                  showMessage(`vibrateTick === ${o.value}`)
                  break;
                case "customize":
                  showMessage(`customize === ${o.value}`)
                  break;
                default: console.error('haptics.sys.dweb 没有匹配的功能 o.operationName === ', o.operationName)
              }
          }while(loop)
      })
      .catch(err => {
          console.error('haptics.sys.dweb err: ')
          console.error(err)
      })
    }

    function showMessage(message){
      const baseStyle = `
        position: absolute;
        top: 80px;
        z-index: 9999999;
        box-sizing: border-box;
        padding: 0px 6px;
        width: 80%;
        height: 38px;
        line-height: 38px;
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        background: #eee;
        border: 1px solid #333;
        border-radius: 5px;
        transition: all 0.25s ease-in-out;
      `
      const el = document.createElement('div')
            el.setAttribute('style', baseStyle)
            el.style.transform = `translateX(-100vw)`
            el.innerText = message
            el.addEventListener('transitionend', () => {
              if(!el.classList.contains('message_after_entry')){
                  el.remove();
              }
            })
      
      setTimeout(() => {
        el.classList.add("message_after_entry")
        el.style.transform = `translateX(0vw)`;
      }, 10)

      setTimeout(() => {
        el.classList.remove("message_after_entry")
        el.style.transform = `translateX(-100vw)`
      }, 1500)

      window.parentElement.append(el)
    }
  </script>
</body>
</html>