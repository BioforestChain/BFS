(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();const y=n=>new w(n);class w{constructor(e=!0){this._cbs=new Set,this._started=!1,this._cachedActions=[],this.listen=t=>(this._cbs.add(t),this._start(),()=>this._cbs.delete(t)),this.emit=(...t)=>{this._startAction(()=>{this._emit(t,this._cbs)})},this.emitAndClear=(...t)=>{this._startAction(()=>{const s=[...this._cbs];this._cbs.clear(),this._emit(t,s)})},this.clear=()=>{this._startAction(()=>{this._cbs.clear()})},e&&this._start()}_start(){if(!this._started&&(this._started=!0,this._cachedActions.length)){for(const e of this._cachedActions)e();this._cachedActions.length=0}}_startAction(e){this._started?e():this._cachedActions.push(e)}_emit(e,t){for(const s of t)try{s.apply(null,e)}catch(r){console.warn(r)}}}class v extends Map{constructor(){super(...arguments),this._changeSignal=y(),this.onChange=this._changeSignal.listen,this.emitChange=(e={add:[],delete:[]})=>this._changeSignal.emit(e)}set(e,t,s=!0){return(this.has(e)&&this.get(e)===t)===!1&&(super.set(e,t),s&&this._changeSignal.emit({add:[e],delete:[]})),this}delete(e,t=!0){return super.delete(e)?(t&&this._changeSignal.emit({add:[],delete:[e]}),!0):!1}clear(){this.size!==0&&(super.clear(),this._changeSignal.emit({add:[],delete:[...this.keys()]}))}reset(){this._changeSignal.clear(),this.clear()}}const b=n=>n instanceof Object&&typeof n.then=="function";class o{constructor(){this.is_resolved=!1,this.is_rejected=!1,this.is_finished=!1,this.promise=new Promise((e,t)=>{this.resolve=s=>{try{b(s)?s.then(this.resolve,this.reject):(this.is_resolved=!0,this.is_finished=!0,e(this.value=s),this._runThen(),this._innerFinallyArg=Object.freeze({status:"resolved",result:this.value}),this._runFinally())}catch(r){this.reject(r)}},this.reject=s=>{this.is_rejected=!0,this.is_finished=!0,t(this.reason=s),this._runCatch(),this._innerFinallyArg=Object.freeze({status:"rejected",reason:this.reason}),this._runFinally()}})}static resolve(e){const t=new o;return t.resolve(e),t}static reject(e){const t=new o;return t.reject(e),t}static sleep(e){const t=new o;let s=setTimeout(()=>{s=void 0,t.resolve()},e);return t.onFinished(()=>s!==void 0&&clearTimeout(s)),t}onSuccess(e){this.is_resolved?this.__callInnerThen(e):(this._innerThen||(this._innerThen=[])).push(e)}onError(e){this.is_rejected?this.__callInnerCatch(e):(this._innerCatch||(this._innerCatch=[])).push(e)}onFinished(e){this.is_finished?this.__callInnerFinally(e):(this._innerFinally||(this._innerFinally=[])).push(e)}_runFinally(){if(this._innerFinally){for(const e of this._innerFinally)this.__callInnerFinally(e);this._innerFinally=void 0}}__callInnerFinally(e){queueMicrotask(async()=>{try{await e(this._innerFinallyArg)}catch(t){console.error("Unhandled promise rejection when running onFinished",e,t)}})}_runThen(){if(this._innerThen){for(const e of this._innerThen)this.__callInnerThen(e);this._innerThen=void 0}}_runCatch(){if(this._innerCatch){for(const e of this._innerCatch)this.__callInnerCatch(e);this._innerCatch=void 0}}__callInnerThen(e){queueMicrotask(async()=>{try{await e(this.value)}catch(t){console.error("Unhandled promise rejection when running onSuccess",e,t)}})}__callInnerCatch(e){queueMicrotask(async()=>{try{await e(this.value)}catch(t){console.error("Unhandled promise rejection when running onError",e,t)}})}}const c=new v;let A=0;const L=()=>A++,S=async(n,e,t,s,r=new URL(n).hostname,i,u)=>{const h=L(),l=URL.createObjectURL(new Blob([`import("${n}")
        .then(
          async({installEnv,Metadata})=>{
            void installEnv(new Metadata(${e},${t}), ${i}, ${u});
            postMessage("ready")
          },
          (err)=>postMessage("ERROR:"+err)
        )`],{type:"text/javascript"})),a=new Worker(l,{type:"module",name:r});await new Promise((d,m)=>{a.addEventListener("message",p=>{p.data==="ready"?d():m(p.data)},{once:!0})}),a.postMessage(["fetch-ipc-channel",s],[s]);const _=new o,f=d=>{Array.isArray(d.data)&&d.data[0]==="env-ready"&&_.resolve()};return a.addEventListener("message",f),await _.promise,a.removeEventListener("message",f),c.set(h,{worker:a,fetch_port:s,env_script_url:n}),{process_id:h}},j=async(n,e,t,s="{}")=>{const r=g(n),i=JSON.parse(e),u=JSON.parse(s);r.worker.postMessage([`ipc-connect/${i.mmid}`,i,u],[t]);const h=new o,l=a=>{Array.isArray(a.data)&&a.data[0]==="ipc-connect-ready"&&a.data[1]===i.mmid&&h.resolve()};r.worker.addEventListener("message",l),await h.promise,r.worker.removeEventListener("message",l)},g=n=>{const e=c.get(n);if(e===void 0)throw new Error(`no found worker by id: ${n}`);return e},F=(n,e)=>{g(n).worker.postMessage(["run-main",e])},M=n=>{const e=c.get(n);return e===void 0?!1:(e.worker.terminate(),c.delete(n),!0)},C={createProcess:S,runProcessMain:F,createIpc:j,destroyProcess:M};Object.assign(globalThis,C);const E=String.raw;c.onChange(()=>{let n="";for(const[e,t]of c)n+=E`<div>
      <span>PID:${e}</span>
      <span>URL:${t.env_script_url}</span>
    </div>`;document.body.innerHTML=n});
